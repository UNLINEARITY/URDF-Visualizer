# URDF Visualizer (Web-based) 项目技术文档

## 1. 项目概述

**URDF Visualizer** 是一个基于 Web 技术的跨平台机器人模型可视化与分析工具。它旨在脱离复杂的 ROS 环境，仅通过现代浏览器即可实现 URDF (Unified Robot Description Format) 模型的加载、渲染、交互控制及运动学数据的实时分析。

本项目采用 **前后端分离** 架构（但通过并发工具整合运行），前端负责核心渲染与交互，后端负责文件资源管理。

---

## 2. 技术栈 (Tech Stack)

### 前端 (Frontend)
*   **框架**: React 18 + TypeScript (提供组件化与类型安全)
*   **构建工具**: Vite (极速开发体验，配置了 API 代理)
*   **3D 引擎**: Three.js (WebGL 渲染库)
*   **模型加载**: `urdf-loader` (解析 URDF XML 并生成 Three.js 对象图)
*   **数学库**: Three.js Math (Matrix4, Quaternion, Vector3, Euler)
*   **UI 交互**: HTML5/CSS3 (自定义深色主题 UI)

### 后端 (Backend)
*   **运行环境**: Node.js
*   **框架**: Express.js (轻量级 Web 服务器)
*   **功能**: 静态资源服务、文件系统遍历 (API `/api/samples`)

### 工具链 (Tooling)
*   **运行管理**: `concurrently` (单命令同时启动前后端)
*   **包管理**: npm

---

## 3. 系统架构与模块设计

项目采用组件化设计，数据流单向流动，但在高性能渲染环节（3D 循环）采用了 Ref 机制以规避 React 闭包陷阱。

### 3.1 目录结构
```text
URDF/
├── public/                 # 存放示例 URDF 模型文件
├── server/                 # 后端服务器代码
│   └── index.js            # Express API 入口
├── src/                    # 前端源代码
│   ├── components/         # React 组件
│   │   ├── Viewer.tsx          # [核心] 3D 渲染引擎、交互逻辑
│   │   ├── JointController.tsx # 关节角度控制滑块
│   │   ├── InfoPopup.tsx       # 浮动信息窗 (矩阵数据显示)
│   │   └── DisplayOptions.tsx  # 可视化选项开关
│   ├── App.tsx             # [入口] 状态管理、布局容器
│   └── style.css           # 全局样式
├── package.json            # 项目依赖与脚本
└── vite.config.ts          # Vite 配置 (含 Proxy 转发)
```

### 3.2 核心组件功能

#### `App.tsx` (中央控制器)
*   **状态管理**: 持有 `robot` 对象、`urdfContent` (XML字符串)、`selection` (当前选中项信息)、`displayOptions` (显示配置)。
*   **数据获取**: 初始化时从后端 API 拉取示例列表；处理文件上传。
*   **布局**: 组织侧边栏与主视口。

#### `Viewer.tsx` (3D 渲染引擎)
*   **场景初始化**: 创建 Scene, Camera, Renderer, Lights, Grid, Axes。
*   **模型管理**: 监听 `robot` prop 变化，负责将机器人模型添加/移除出场景，并修正坐标系 (Z-up 转 Y-up)。
*   **交互逻辑 (Raycasting)**:
    *   监听 `contextmenu` (右键) 事件。
    *   实现射线检测，向上遍历对象树查找 `isURDFLink` 或 `isURDFJoint` 属性，精准拾取机器人部件。
    *   **高亮系统**: 使用材质替换 (`MeshBasicMaterial`) 实现选中高亮，支持透明度与深度测试关闭 (DepthTest false)。
*   **性能优化**: 使用 `useRef` 存储回调函数和状态，确保 `requestAnimationFrame` 循环中始终访问最新数据，避免 Stale Closure 问题。
*   **实时更新**: 在渲染循环中调用 `updateWorldMatrix`，并实时通过 `onMatrixUpdate` 回调将矩阵数据传回 UI。

#### `JointController.tsx` (运动学控制)
*   **动态生成**: 解析 `robot.joints`，自动过滤 `fixed` 关节。
*   **类型适配**: 根据关节类型 (`revolute`, `prismatic`, `continuous`) 自动适配滑块的单位 (度/米) 和范围。
*   **驱动**: 直接操作 `robot.setJointValue()` 驱动模型运动。

#### `InfoPopup.tsx` (数据可视化)
*   **数学可视化**: 将 4x4 变换矩阵分解为 位置 (XYZ)、欧拉角 (RPY)、四元数 (Quaternion)。
*   **交互**: 支持拖拽移动 (Draggable)。
*   **智能定位**: 采用“本地状态优先 + 结束同步”策略，解决拖拽不跟手问题；修正了父容器 `relative` 定位导致的坐标偏移。

---

## 4. 关键技术实现细节

### 4.1 URDF 加载与坐标系校正
*   **加载**: 使用 `FileLoader` 读取文本，`URDFLoader.parse` 进行解析。
*   **校正**: URDF 标准通常使用 **Z-axis up**，而 Three.js 默认 **Y-axis up**。我们在 `Viewer.tsx` 中对加载的 Robot Object 进行了 `rotation.x = -Math.PI / 2` 旋转，使其直立显示。

### 4.2 交互式拾取 (Picking)
我们没有使用简单的 Mesh 拾取，而是实现了**层级回溯拾取**：
1.  射线击中 Mesh。
2.  循环访问 `object.parent`。
3.  检查属性 `isURDFLink` 或 `isURDFJoint` (由 `urdf-loader` 注入)。
4.  锁定整个逻辑部件而不仅仅是几何面片。

### 4.3 解决 React 与 3D 循环的冲突
在 `Viewer.tsx` 的 `animate` 循环中，不能直接依赖 React 的 props，因为闭包会“捕获”旧值。
**解决方案**:
```typescript
const onMatrixUpdateRef = useRef(onMatrixUpdate);
// 每次渲染更新 Ref
useEffect(() => { onMatrixUpdateRef.current = onMatrixUpdate; }, [onMatrixUpdate]);
// 循环中使用 Ref 调用
const animate = () => {
  // ...
  onMatrixUpdateRef.current(...);
}
```

### 4.4 浮动窗的拖拽算法
为了实现完美的拖拽体验，采用了**父容器相对坐标修正**算法：
`NewPosition = (MouseClientPos - ParentContainerOffset) - InitialClickOffsetInsidePopup`
这确保了无论父容器如何定位，弹窗都能精确跟随鼠标。

---

## 5. 项目运行指南

得益于 `concurrently` 的配置，项目支持单命令启动。

1.  **安装依赖** (首次运行):
    ```bash
    npm install         # 安装根目录依赖
    cd server && npm install # 安装后端依赖
    ```

2.  **启动开发环境**:
    ```bash
    npm run dev
    # 该命令会同时启动:
    # 1. Vite 前端服务器 (Port 5173)
    # 2. Express 后端服务器 (Port 3001)
    ```

3.  **访问**: 打开浏览器访问 `http://localhost:5173`。

---

## 6. 未来演进路线 (Roadmap)

基于当前坚实的基础，项目计划向更高级的机器人学分析工具演进：

1.  **正向运动学 (已完成)**: 实时显示变换矩阵与位姿。
2.  **逆向运动学 (IK)**: 集成 IK 解算器，允许通过拖拽末端执行器 (End Effector) 来反向驱动关节。
3.  **动力学分析**: 可视化雅可比矩阵 (Jacobian Matrix)，通过颜色热力图显示机器人的可操作度 (Manipulability) 和奇点 (Singularity)。
4.  **轨迹规划**: 支持关键帧录制与回放。

---
*Generated by Gemini CLI Agent - 2025*
